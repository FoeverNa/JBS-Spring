# day11

**지난시간복습**



**이번시간**

- FlatformTransactionManage라는애가 있는데 디비연동 기술에 따라 달라진다.
  - Hibernate, JDBC, mybatics냐에 따라서 트랙스액션 매니저 클래스가 달라져야한다는 뜻
    - 왜냐면 db연동기술에 따라 커밋과 rollback 알고리즘이 다를 수 밖에 없기 때문이다 -==========> 이게중요한부분
- JDBCTemplate이나 myBatic했다면 DataTransacionManager쓰고 hiberate쓰면 HibernateTransctionManer, JJpaTransactionManager로 구현해주면 된다
  - xml에서 교체해서 사용만 하면된다
- 트랙젝션 Advice 클래스 등록이 중요하다
  - AOP의 Advice와 다르게  트랜젝션 Advice를 구현하지 않는다
  - 가능하지만 경우의 수가 너무 많기 때문에 몇천줄이 나올수있고 검증이 불가능하다
    - 그래서 컨테이너가 생성해주는 어드바이스를 쓰재
    - 몇줄에 설정을 넘겨주면 알아서 Advice객체만들어준다
  - txManager를 참조하면 어드바이스 객체가 르랜스엑션매니저통해서 커밋롤백한다
    - 모든 종류의 exception이 생기면 롤백하고, 발생하지 않으면 커밋한다
    - 커밋과 롤백을 매니저 객체를 이용해서 해라
- 질문
  - txAdvice가 예외가 발생했을때 롤백하라고 설정되어있으면 insert에서 예외발생하면 동작하나? 안한다 왜?
    - 포인트컷이 없기 때문에.. 그리고 포인트컷과 어드바이스를 연결하는 어스팩트가 없기 때문
    - 그래서 aop설정이 필요하다
- AOP설정
  - 트랜잭션에서는 Aspect대신 Advisor를 사용한다
    - 왜? Aspect는 Adive에 method명을 알수있을때만 사용할수있다 -> method가 속성으로들어가야된까
    - 근데 txAdvice는 내가 작성한 메서드가 아니기 때문에 method명을 모르고 속성값을 줄수가 없다. 그래서 Advisor사용한다
      - 메소드이름만 모를뿐이지 개념은 똑~같~다~~
  - 포인트컷을 작성하고 미리작성해놓은 advice와 advisor로 연결한다
  - 모든메소드를 포인트컷 범위를 지정하였다 하더라도 의미가 있는게 포인트컷 지정이 안되면 어드바이스가 작동을안하기 때문이다
- 실습 - 예외발생하는 
  - (SELECT NVL(MAX(SEQ), 0) + 1 FROM BOARD) 빼고 insert 두번하기
  - DAO단위로 하는게 아니라 Imple단위로 트랜잭션 관리된다 =>>>>>>>>>>>>>이게참신기하다
    - 포인트컷을 *Impl로 주엇기 때문에
  - insert가 seq가 같은게 2번입력되면 sql 예외가 발생해야한다
  - 트랜잭션xml지우고햇을때 예외발생하지만 100번에 글 등록됬다 
    - 다시 트랜잭션xml등록하고 101번글 2번등록하게 하면 예외발생하고 101번에 글 등록이 안되어있다

트랜잭션끝!



- SpringPresentationProject
  
- BusinessProject와 MVCProject에서 파일들 옮겨오기
  
- 스프링 프로젝트할 때 비지니스 레이어와 프레젠테이션 레이어로 나누어서 구현한다

  - twoLayer Layer
  - 모든 스프링 프로젝트는 2개의 프로젝트로 나뉜다
  - 비지니스 레이어
    - IoC와 AoP로 개발한다
      - IoC는 객체생성과 의존관계
        - 객체생성:빈등록하거나 컴포넌트스캔
        - 의존관계: 세터, 생성자, 타입 인젝션(아마 그거 필드인젝션)
    - 모든비지니스 컴포넌트는 4개의 자바가 한세트
      - 서비스임플, 서비스, 다오, 브이오
      - 컨테이너는 임플과 dao만 생성해준다
        - vo는 컨트롤러쪽에서 입력해서 넘겨준다
      - @Service => 바뀌지 않으니까
      - DAO는 빈등록 => 바뀔수 있으니까
        - Autowired 설정 했다
        - 여기까지가 IOC
    - AOP는?
      - 서비스 임플에 메소드가 숫자가 많은데 트랜잭션을 관리하려면?
      - 포인트컷 걸고 tx어드바이스 객체만들고 그외에 많은 어드바이스 만들었다
        - 그다음 포인트컷과 어드바이스 연결해주는 어스펙트 만들어줘야지

  

- 이제는 비지니스 그만보고 MVC볼거다

  - 비지니스컴포넌트가 Model 이고 JSP가 View이고 그외 DispatcherService와 Controller와 같은게 Controller다

- 지금부터는 DispatcherService 서블릿의 기능을 분산 시킬 것이다

  

- Model

  - JSP와 VoDAO만으로 개발했던게 Mode1
  - Controller로직 => 3가지 PPT확인

- Mod2

  - 기능들을 서블릿을통해 빼오자
  - 그래서 jps에 el과 머쩌시기썼다

- 거기서 더나아가서 컨트롤러는 프레임워크에 맡기자

  - 모델과 뷰는 프레임워크가 자동으로 제공하지는 않는다. 컨트롤로만 제공한다

- DspatcherSErvlet을 3개의 기능으로 분화시키는 것을 직접해볼거야

  - 실제 프로젝트는 스프링으로 해주지만 만들어보고 안해보고는 구조를 이해하는데 도움이 된다



- 디스패쳐 백업만들기
- 디스패쳐 서블릿 바꾸기
  - 핸들러 뷰리졸버 변수만들기
  - 1번만 남기고 본문 지우기
- 모든 .do를 DipatS가 받는다
  - init을 실행한다
    - 핸들러 뷰리졸버 생성
    - 핸들러매핑이 중요하다
      - 해쉬맵 컬렉션을 맴버로가지고 있으며 키벨류상에수많은객체를 가지고있는데 (지금은 겟보드만)
      - 뷰리졸버는 셋 프리픽스와 셋서픽스를하고(접두사접미사) getView하면 veiw이름 앞뒤에 접두사 접미사를 붙여서 리턴한다
        - geboardList 면 ./getBoardList.jsp로 바꿔주는것
    - 둘다 딱 하나씩만 객체를 하나만 뜬다
      - 디스펫처서블릿도하나 뷰리졸버랑 핸드러패핑도 하나
  - serviemethod가 실행된다
    - 서비스메소드는 유지보수과정에서 바뀌지 않는다
      - 새로운 요청이와도 수정되지 않게 구조화되어있다
    - 패스 추출해주고
    - 핸들러매핑에게 팻쓰로 객체하나 검색해서 해당 객체를 리턴한다
    - 해당 객체에 handleRequetst 호출
      - 로직처리하고 세션에 저장한 뒤에 getboard 문자 리턴
    - 뷰리졸버에서 gtview해서 sendRedirect해주기
  - MVC Framework 구조 그림 보면서 한번 더 체크하기
  - 로그인.html변경하기
    - jsp로 변경하고
    - 웰컴파일 변경하기
    - 서버.xml열어서 바꾸기
      - 프로젝트 여러개 넣어버리면 그렇게 동작을안해
    - 나머지다만들기

- 관리자 권한이 ADMIN일때만 글삭제 수정할 수 있는 필터만들기
  - 복습해보기
  - HttpReqest 가 아니라 HttpServletRequest로 바꾸어줫어야했다
  - 나중에 스프링 시큐리티할때 필터로구현할수있어 체크해보면좋다
- 유저이름 넣는거확인하기

- 지금까지 한게 MVC 프레임웤잉ㄴ데 내가 구현했다

  - 이제중요한건 스프링걸로 바꿔치기할거야

- web.xml을 수정

  - 서블릿 패키지만 바꿔준다
  - 그렇게 톰캣실행하고 로그인하면 에러난다
    - actionServlet에 init메소드에서 에러가 낫다고한다
  - 원인
    - .do요청이 날라온것임 로그인할때
    - 서블릿 객체 생성할때 init메서드가 바로 실행되는데 거기서 에러가 났다
  - 두종류의 스프링 컨테이너가 있는데
    - GenerixXmlApplicationContext는 웹이 아닌 경우에 사용한다
      - 생성하기가 너무쉽다 xml 설정파일만있으면됨
    - 이제는 XmlWebApplicationContext는 웹환경에서 사용한다 => 더중요하다
      - 내가 직접생성할수가 없다
      - xml 설정파일  +4개의 객체가 필요하다
        - 웹의 특성상 사전처리가 필요하다는 의미이다
          - 직접생성할수있지만 그럴필요는없다
          - DispatcherServlet에 init메서드가 코드를 가지고 있고 걔가 실행되면 XmlWebApplicatoinContext가 생성된다(스프링컨테이너가 생성된다)
          - 근데 그걸 실행할라면 action-servlet.xml이게 실행되야된다라고 로그가뜸 그래서 만들어줌
            - 그리고 컨트롤러 빈등록해줌
  - 우리가 MVC에 필요한거 다만들었는데 이제 다 필요가 없다
  - 서블릿 컨테이너와 스프링 컨테이너의 관계
    - 서블릿 컨테이너는 톰캣 서버가 생성해준다
    - 브라우저에서 요청이 들어와야(.do) 서블릿컨테이너가 그때 디스패쳐 서블릿이 web.xml 생성된다
    - 이제 이 디스패처서블릿은 new xmlWebApplicationContext()를 생성한다
      - 그 컨테이너는 action-sevlet.xml을 로딩해서 생성한다

  - 그럼 왜 디스패처 서블릿은 스플릿 컨테이너를 생성해야 하는걸까? ==>>>>>>>>>>>젤중요
    - web.xml에 등록할수있는애는 서블릿, 필터, 리스너 3종류이다. 다른클래스는 등록할수가 없다
    - 근데 디스패처서블릿가 다른 클래스들이랑 상호작용할때 누군가 일반 클래스들을 생성해줄 필요가있다
      - 그럼 그 객체생성을 누가해주냐? POJO객체 객체생성은/?? 바로 스프링 컨테이너
        - 헬로월드 같은 일반 자바클래스를 생성해서 관리해줄수 있는 유일한 컨테이너는 스프링이다
    - 웹을 개발하려면 두종류의 컨테이너가 필요하다 서블릿 컨테이너와 스프링 컨테이너 => 두개의 역할이 다르다
    - 서블릿 컨테이너는 톰캣이 생성하고 Spring컨테이너는 DispaterServlet이 생성해준다
      - 내가 하는게 하나도 없다. 그래서 어렵다
    - 톰캣서버온 - 서블릿엔진온 - 요청드러올때까지 대기 - 요청들어옴 - 서블릿객체생성 - 서블릿이 이닛하면서 스프링컨테이너 생성 - 스프링 xml에 등록된 bean 객체 생성

- bean을 handlerMApping에 id는 마음대로 등록하면 안된다, handlerMapping
  - dispacterServlet에 상수로 선언되어있는 클래스들은 id가 fix가 되어있다
  - 내가 만든건 맘대로하지만 스프링이 만들어준 클래스는 끝에 두단어하고 앞에 소문자로 만들어주면된다. 그럼발샐일이 없다
- 프로퍼티 세터할때 콜렉션주려고하면?
  - 프로프티스 넣으려면 props를 써야한다
- 우리가 만든 핸드러매핑하고 비슷하다는것 확인하기
  - 스프링이 제공하는게 훨신 효율적이다
    - 만약 새로운 기능이들어오면  컨트롤러 떠만들어서 등록해야함
    - 하지만 xml로 하면 자바소스안건드리고 한줄만추가하면된다
- 담주금요일에는 프로젝트를 하나 주고간다



- 숙제 = session을 이용해서 내가 검색버튼을 눌렀을때 검색조건과 키워드가 지속적으로 유지되도록 하는게 숙제



- 이름바꾸기
  - 폴더랑 이름로바꿨는데 안되 - 기본 설정이있기때문
  - init-param으로 설정해준다
  - contextConfigLocation 이라는 파람있으면 거기서 읽어드린다
    - 재구동하고 했더니 잘되고 로그도 바뀌어있다
    - 심플핸들러매핑도 로그로 띠ㅡ워준다
      
      - 내가만든거랑또같다
      
        
- ViewResolver등록
  - 엄청 중요한 기능을제공한다
  - WEb-INF 디렉토리는 절대로 브라우저에서 액세스가 안된다. 중요한파일을들은 다여기에 감추면된다
    - 그래서 board폴더만들어서 jps파일 숨긴다
    - 해당 주소로 접근하면 404가 뜬다
  - 이때 뷰리졸버가 서버는접근가능할수있도록 해준다
  - 매핑이 좀 햇깔려서 잘살펴보야겠다- > 설명부분에 멍때렷다



- 디스패처서블릿이 무슨역할햇더라?
- 컨트롤러
- 그다음에 뷰리졸버
- 핸들러이렇게 햇다
- 처음에 패쓰받아서
- 핸들러한테 객체 가져와
- 그다음에 객체 실행해?
- 

